function slimeyClick(e){return this.slimey.editor.click(this),stopPropagation(e),!1}function slimeyHighlight(){this.className="slimeyHighlightedElement"}function slimeyLowshadow(){this==this.slimey.editor.getSelected()?this.className="slimeySelectedElement":this.className="slimeyElement"}function slimeyDrag(e){var e;return e||(e=window.event),this.slimey.editor.drag(this,e),stopPropagation(e),!1}function slimeyMove(e){var e;e||(e=window.event);try{this.slimey.editor.move(e),stopPropagation(e)}catch(e){}return!1}function slimeyDrop(){this.slimey.editor.drop()}function slimeyDeselect(){try{this.slimey.editor.deselect()}catch(e){}}function slimeyEdit(e){return this.slimey.editor.dblclick(this,e),stopPropagation(e),!1}var SlimeyEditor=function(e){this.slimey=e,this.current=null,this.selected=null,this.container=document.createElement("div"),this.container.id="Edcontainer",this.undoStack=new SlimeyStack,this.redoStack=new SlimeyStack,this.events=[],this.events.selectionChange=[],this.events.actionPerformed=[],this.contentEditor=document.createElement("textarea"),this.contentEditor.slimey=this.slimey,this.contentEditor.id="contentEditor",this.contentEditor.style.position="absolute",this.contentEditor.style.zIndex="20000",this.contentEditor.style.overflow="visible",this.contentEditor.style.visibility="hidden",this.contentEditor.style.top=-1e3,this.contentEditor.style.backgroundColor="#FFFFEE",this.contentEditor.systemElement=!0,this.container.appendChild(this.contentEditor),this.resizeHandle=document.createElement("div"),this.resizeHandle.slimey=this.slimey,this.resizeHandle.className="resizeHandle",this.resizeHandle.style.zIndex=1e8,this.resizeHandle.style.position="absolute",this.resizeHandle.style.visibility="hidden",this.resizeHandle.systemElement=!0,this.container.appendChild(this.resizeHandle),this.container.className="slimeyEditor",this.container.slimey=this.slimey,this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.padding="0px",this.container.style.overflow="hidden",this.container.style.fontSize="25px",this.container.style.cursor="default",this.container.style.width="640px",this.container.style.height="480px",this.container.style.fontSize="20px",setEventHandler(this.container,"mousemove",slimeyMove),setEventHandler(this.container,"mouseup",slimeyDrop),setEventHandler(this.container,"click",slimeyDeselect),setEventHandler(this.container,"resize",this.resized,this),addEventHandler(window,"resize",this.resized,this),addEventHandler(window,"load",this.resized,this),setEventHandler(this.resizeHandle,"mousedown",slimeyDrag),setEventHandler(this.contentEditor,"blur",function(){var e=this.value;this.editElement.tagName=="UL"||this.editElement.tagName=="OL"?(e="<li>"+e+"</li>",e=e.replace(/\n/g,"</li><li>")):this.editElement.tagName=="DIV"&&(e=e.replace(/\n/g,"<br>"));var t=new SlimeyEditContentAction(this.slimey,e,this.editElement);this.slimey.editor.performAction(t),this.style.visibility="hidden",this.style.top=-1e3,this.editElement=null}),setEventHandler(this.contentEditor,"keyup",function(e){if(!e)var e=window.event;e.keyCode==27&&this.onblur()}),setEventHandler(this.contentEditor,"click",function(e){return e||(e=window.event),stopPropagation(e),!1})};SlimeyEditor.prototype.getContainer=function(){return this.container},SlimeyEditor.prototype.getHTML=function(){var e,t;this.selected&&(this.selected.className="slimeyElement"),e="";for(t=this.container.firstChild;t;t=t.nextSibling)t.nodeType==1&&!t.systemElement&&(e+="<"+t.tagName.toLowerCase(),t.src&&(e+=' src="'+t.src+'"'),e+=' style="'+t.style.cssText+'"',e+=">\n",t.innerHTML&&(e+=t.innerHTML+"\n"),e+="</"+t.tagName.toLowerCase()+">\n");return this.selected&&(this.selected.className="slimeySelectedElement"),e},SlimeyEditor.prototype.setHTML=function(e){var t;this.deselect(),this.container.innerHTML=e;for(t=this.container.firstChild;t;t=t.nextSibling)t.nodeType==1&&(t.slimey=this.slimey,setEventHandler(t,"mousedown",slimeyDrag),setEventHandler(t,"click",slimeyClick),setEventHandler(t,"mouseover",slimeyHighlight),setEventHandler(t,"mouseout",slimeyLowshadow),setEventHandler(t,"dblclick",slimeyEdit),t.tagName=="IMG"?(t.resizable=!0,t.title=lang("drag the bottom right corner to resize")):(t.editable=!0,t.resizable=!0,t.title=lang("double click to edit content")),t.className="slimeyElement",t.style.zIndex||(t.style.zIndex=1e4),t.style.cursor="move");this.container.appendChild(this.resizeHandle),this.container.appendChild(this.contentEditor)},SlimeyEditor.prototype.getDOM=function(e){var t,n;for(t=0;t<this.container.childNodes.length;t++)n=this.container.childNodes.item(t),n.systemElement||(this.container.removeChild(n),t--,e.appendChild(n));return e},SlimeyEditor.prototype.setDOM=function(e){var t,n;this.deselect();for(t=0;t<this.container.childNodes.length;t++)n=this.container.childNodes.item(t),n.systemElement||(this.container.removeChild(n),t--);for(t=0;t<e.childNodes.length;t++)n=e.childNodes.item(t),e.removeChild(n),t--,this.container.appendChild(n)},SlimeyEditor.prototype.getSelected=function(){return this.selected},SlimeyEditor.prototype.select=function(e){this.selected&&this.deselect(),this.selected=e,e.className="slimeySelectedElement",this.fireEvent("selectionChange"),e.resizable&&(this.resizeHandle.style.visibility="visible",this.resizeHandle.style.left=getPercentValue(e.style.left)+getPercentValue(e.style.width)+"%",this.resizeHandle.style.top=getPercentValue(e.style.top)+getPercentValue(e.style.height)+"%")},SlimeyEditor.prototype.deselect=function(){this.selected&&(this.selected.className="slimeyElement"),this.selected=null,this.resizeHandle.style.visibility="hidden",this.fireEvent("selectionChange")},SlimeyEditor.prototype.performAction=function(e){e.perform(),this.undoStack.push(e),this.redoStack.clear(),this.fireEvent("actionPerformed")},SlimeyEditor.prototype.undo=function(){var e=this.undoStack.pop();e&&(e.undo(),this.redoStack.push(e)),this.fireEvent("actionPerformed")},SlimeyEditor.prototype.redo=function(){var e=this.redoStack.pop();e&&(e.perform(),this.undoStack.push(e)),this.fireEvent("actionPerformed")},SlimeyEditor.prototype.addEventListener=function(e,t,n){var r=this.events[e];r[r.length]={callback:t,scope:n}},SlimeyEditor.prototype.removeEventListener=function(e,t){var n=this.events[e];for(i=0;i<n.length;i++)n[i]==t&&(n.length>1&&(n[i]=n[n.length]),n.length--)},SlimeyEditor.prototype.fireEvent=function(e){var t=this.events[e];for(i=0;i<t.length;i++)t[i].callback.call(t[i].scope)},SlimeyEditor.prototype.click=function(e){e!=this.selected&&this.select(e)},SlimeyEditor.prototype.dblclick=function(e){var t;e!=this.selected&&this.select(e);if(!e.editable)return;this.contentEditor.editElement=e,this.contentEditor.style.visibility="visible",this.contentEditor.style.fontFamily=e.style.fontFamily,this.contentEditor.style.color=e.style.color,this.contentEditor.style.fontSize=e.style.fontSize,this.contentEditor.style.fontWeight=e.style.fontWeight,this.contentEditor.style.fontStyle=e.style.fontStyle,this.contentEditor.style.textDecoration=e.style.textDecoration,this.contentEditor.style.left=e.style.left,this.contentEditor.style.top=e.style.top,this.contentEditor.style.width=e.style.width,this.contentEditor.style.height=e.style.height,t=e.innerHTML,e.tagName=="UL"||e.tagName=="OL"?(t=t.replace(/<\/li><li>/gi,"\n"),t=t.replace(/<li>|<\/li>/gi,"")):e.tagName=="DIV"&&(t=t.replace(/<br>/gi,"\n")),this.contentEditor.value=t,this.contentEditor.focus()},SlimeyEditor.prototype.drag=function(e,t){var n,r,i,s,o;this.current=e,e.systemElement||this.select(e),n=getMousePosition(t,this.container),this.hSize=this.container.offsetWidth,this.vSize=this.container.offsetHeight,r=getPercentValue(e.style.left),i=getPercentValue(e.style.top),r>100&&(r=50),i>100&&(i=50),s=Math.round(r*this.hSize/100),o=Math.round(i*this.vSize/100),this.difx=n.x-s,this.dify=n.y-o,this.dragx=this.movex=r,this.dragy=this.movey=i},SlimeyEditor.prototype.move=function(e){var t;this.current&&(t=getMousePosition(e,this.container),this.movex=Math.round((t.x-this.difx)*100/this.hSize),this.movey=Math.round((t.y-this.dify)*100/this.vSize),this.current.style.left=this.movex+"%",this.current.style.top=this.movey+"%",this.printDebug("("+this.current.style.left+", "+this.current.style.top+")"),this.current.resizable&&(this.resizeHandle.style.left=getPercentValue(this.current.style.left)+getPercentValue(this.current.style.width)+"%",this.resizeHandle.style.top=getPercentValue(this.current.style.top)+getPercentValue(this.current.style.height)+"%")),this.current==this.resizeHandle&&(this.selected.style.width=getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left)+"%",this.selected.style.height=getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top)+"%")},SlimeyEditor.prototype.drop=function(){var e,t,n,r,i;if(this.current)if(!this.current.systemElement)this.current.style.position=="absolute"&&(this.dragx!=this.movex||this.dragy!=this.movey)&&(e=new SlimeyMoveAction(this.slimey,this.movex+"%",this.movey+"%",this.dragx+"%",this.dragy+"%"),this.performAction(e));else{t=getPercentValue(this.resizeHandle.style.left)-getPercentValue(this.selected.style.left)+"%",n=getPercentValue(this.resizeHandle.style.top)-getPercentValue(this.selected.style.top)+"%",r=this.dragx-getPercentValue(this.selected.style.left)+"%",i=this.dragy-getPercentValue(this.selected.style.top)+"%";if(t!=r||n!=i)e=new SlimeyResizeAction(this.slimey,t,n,r,i),this.performAction(e),this.contentEditor.editElement&&(this.contentEditor.style.width=t,this.contentEditor.style.height=n)}this.current=null},SlimeyEditor.prototype.resized=function(){var e=this.container.offsetHeight;this.container.style.fontSize=e/24+"px"},SlimeyEditor.prototype.printDebug=function(){};