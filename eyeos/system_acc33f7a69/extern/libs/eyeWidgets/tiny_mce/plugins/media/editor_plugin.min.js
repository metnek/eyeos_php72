(function(){function o(e){var t,n;if(e&&!e.splice){t=[];for(n=0;!0;n++){if(!e[n])break;t[n]=e[n]}return t}return e}var e,t=tinymce.explode("id,name,width,height,style,align,class,hspace,vspace,bgcolor,type"),n=tinymce.makeMap(t.join(",")),r=tinymce.html.Node,i=tinymce.util.JSON,s=[["Flash","d27cdb6e-ae6d-11cf-96b8-444553540000","application/x-shockwave-flash","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["ShockWave","166b1bca-3f9c-11cf-8075-444553540000","application/x-director","http://download.macromedia.com/pub/shockwave/cabs/director/sw.cab#version=8,5,1,0"],["WindowsMedia","6bf52a52-394a-11d3-b153-00c04f79faa6,22d6f312-b0f6-11d0-94ab-0080c74c7e95,05589fa1-c356-11ce-bf01-00aa0055595a","application/x-mplayer2","http://activex.microsoft.com/activex/controls/mplayer/en/nsmp2inf.cab#Version=5,1,52,701"],["QuickTime","02bf25d5-8c17-4b23-bc80-d3488abddc6b","video/quicktime","http://www.apple.com/qtactivex/qtplugin.cab#version=6,0,2,0"],["RealMedia","cfcdaa03-8be4-11cf-b84b-0020afbbccfa","audio/x-pn-realaudio-plugin","http://download.macromedia.com/pub/shockwave/cabs/flash/swflash.cab#version=6,0,40,0"],["Java","8ad9c840-044e-11d1-b3e9-00805f499d93","application/x-java-applet","http://java.sun.com/products/plugin/autodl/jinstall-1_5_0-windows-i586.cab#Version=1,5,0,0"],["Silverlight","dfeaf541-f3e1-4c24-acac-99c30715084a","application/x-silverlight-2"],["Iframe"],["Video"],["EmbeddedAudio"],["Audio"]];tinymce.create("tinymce.plugins.MediaPlugin",{init:function(n,r){function h(e){return e&&e.nodeName==="IMG"&&n.dom.hasClass(e,"mceItemMedia")}var o,u,a,f,l=this,c={};l.editor=n,l.url=r,e="";for(o=0;o<s.length;o++){f=s[o][0],a={name:f,clsids:tinymce.explode(s[o][1]||""),mimes:tinymce.explode(s[o][2]||""),codebase:s[o][3]};for(u=0;u<a.clsids.length;u++)c["clsid:"+a.clsids[u]]=a;for(u=0;u<a.mimes.length;u++)c[a.mimes[u]]=a;c["mceItem"+f]=a,c[f.toLowerCase()]=a,e+=(e?"|":"")+f}tinymce.each(n.getParam("media_types","video=mp4,m4v,ogv,webm;silverlight=xap;flash=swf,flv;shockwave=dcr;quicktime=mov,qt,mpg,mpeg;shockwave=dcr;windowsmedia=avi,wmv,wm,asf,asx,wmx,wvx;realmedia=rm,ra,ram;java=jar;audio=mp3,ogg").split(";"),function(e){var t,n,r;e=e.split(/=/),n=tinymce.explode(e[1].toLowerCase());for(t=0;t<n.length;t++)r=c[e[0].toLowerCase()],r&&(c[n[t]]=r)}),e=RegExp("write("+e+")\\(([^)]+)\\)"),l.lookup=c,n.onPreInit.add(function(){n.schema.addValidElements("object[id|style|width|height|classid|codebase|*],param[name|value],embed[id|style|width|height|type|src|*],video[*],audio[*],source[*]"),n.parser.addNodeFilter("object,embed,video,audio,script,iframe",function(e){var t=e.length;while(t--)l.objectToImg(e[t])}),n.serializer.addNodeFilter("img",function(e,t,n){var r,i=e.length;while(i--)r=e[i],(r.attr("class")||"").indexOf("mceItemMedia")!==-1&&l.imgToObject(r,n)})}),n.onInit.add(function(){n.theme&&n.theme.onResolveName&&n.theme.onResolveName.add(function(e,t){t.name==="img"&&n.dom.hasClass(t.node,"mceItemMedia")&&(t.name="media")}),n&&n.plugins.contextmenu&&n.plugins.contextmenu.onContextMenu.add(function(e,t,n){n.nodeName==="IMG"&&n.className.indexOf("mceItemMedia")!==-1&&t.add({title:"media.edit",icon:"media",cmd:"mceMedia"})})}),n.addCommand("mceMedia",function(){var e,s=n.selection.getNode();h(s)&&(e=n.dom.getAttrib(s,"data-mce-json"),e&&(e=i.parse(e),tinymce.each(t,function(t){var r=n.dom.getAttrib(s,t);r&&(e[t]=r)}),e.type=l.getType(s.className).name.toLowerCase())),e||(e={type:"flash",video:{sources:[]},params:{}}),n.windowManager.open({file:r+"/media.htm",width:430+parseInt(n.getLang("media.delta_width",0)),height:500+parseInt(n.getLang("media.delta_height",0)),inline:1},{plugin_url:r,data:e})}),n.addButton("media",{title:"media.desc",cmd:"mceMedia"}),n.onNodeChange.add(function(e,t,n){t.setActive("media",h(n))})},convertUrl:function(e,t){var n=this,r=n.editor,i=r.settings,s=i.url_converter,o=i.url_converter_scope||n;return e?t?r.documentBaseURI.toAbsolute(e):s.call(o,e,"src","object"):e},getInfo:function(){return{longname:"Media",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/media",version:tinymce.majorVersion+"."+tinymce.minorVersion}},dataToImg:function(e,t){var n,r,s,u,a=this,f=a.editor,l=f.documentBaseURI;e.params.src=a.convertUrl(e.params.src,t),r=e.video.attrs,r&&(r.src=a.convertUrl(r.src,t)),r&&(r.poster=a.convertUrl(r.poster,t)),n=o(e.video.sources);if(n)for(u=0;u<n.length;u++)n[u].src=a.convertUrl(n[u].src,t);return s=a.editor.dom.create("img",{id:e.id,style:e.style,align:e.align,hspace:e.hspace,vspace:e.vspace,src:a.editor.theme.url+"/img/trans.gif","class":"mceItemMedia mceItem"+a.getType(e.type).name,"data-mce-json":i.serialize(e,"'")}),s.width=e.width||(e.type=="audio"?"300":"320"),s.height=e.height||(e.type=="audio"?"32":"240"),s},dataToHtml:function(e,t){return this.editor.serializer.serialize(this.dataToImg(e,t),{forced_root_block:"",force_absolute:t})},htmlToData:function(e){var n={type:"flash",video:{sources:[]},params:{}},r=this.editor.parser.parse(e),s=r.getAll("img")[0];return s&&(n=i.parse(s.attr("data-mce-json")),n.type=this.getType(s.attr("class")).name.toLowerCase(),tinymce.each(t,function(e){var t=s.attr(e);t&&(n[e]=t)})),n},getType:function(e){var t,n,r=tinymce.explode(e," ");for(t=0;t<r.length;t++){n=this.lookup[r[t]];if(n)return n}},imgToObject:function(e,n){function N(e,t){var n,r,i,s,o=T.getParam("flash_video_player_url",x.convertUrl(x.url+"/moxieplayer.swf"));o&&(n=T.documentBaseURI,c.params.src=o,T.getParam("flash_video_player_absvideourl",!0)&&(e=n.toAbsolute(e||"",!0),t=n.toAbsolute(t||"",!0)),i="",r=T.getParam("flash_video_player_flashvars",{url:"$url",poster:"$poster"}),tinymce.each(r,function(n,r){n=n.replace(/\$url/,e||""),n=n.replace(/\$poster/,t||""),n.length>0&&(i+=(i?"&":"")+r+"="+escape(n))}),i.length&&(c.params.flashvars=i),s=T.getParam("flash_video_player_params",{allowfullscreen:!0,allowscriptaccess:!0}),tinymce.each(s,function(e,t){c.params[t]=""+e}))}var s,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x=this,T=x.editor;c=e.attr("data-mce-json");if(!c)return;c=i.parse(c),v=this.getType(e.attr("class")),w=e.attr("data-mce-style"),w||(w=e.attr("style"),w&&(w=T.dom.serializeStyle(T.dom.parseStyle(w,"img"))));if(v.name==="Iframe"){y=new r("iframe",1),tinymce.each(t,function(t){var n=e.attr(t);t=="class"&&n&&(n=n.replace(/mceItem.+ ?/g,"")),n&&n.length>0&&y.attr(t,n)});for(f in c.params)y.attr(f,c.params[f]);y.attr({style:w,src:c.params.src}),e.replace(y);return}if(this.editor.settings.media_use_script){y=(new r("script",1)).attr("type","text/javascript"),l=new r("#text",3),l.value="write"+v.name+"("+i.serialize(tinymce.extend(c.params,{width:e.attr("width"),height:e.attr("height")}))+");",y.append(l),e.replace(y);return}if(v.name==="Video"&&c.video.sources[0]){s=(new r("video",1)).attr(tinymce.extend({id:e.attr("id"),width:e.attr("width"),height:e.attr("height"),style:w},c.video.attrs)),c.video.attrs&&(b=c.video.attrs.poster),p=c.video.sources=o(c.video.sources);for(m=0;m<p.length;m++)/\.mp4$/.test(p[m].src)&&(g=p[m].src);p[0].type||(s.attr("src",p[0].src),p.splice(0,1));for(m=0;m<p.length;m++)h=(new r("source",1)).attr(p[m]),h.shortEnded=!0,s.append(h);g?(N(g,b),v=x.getType("flash")):c.params.src=""}if(v.name==="Audio"&&c.video.sources[0]){E=(new r("audio",1)).attr(tinymce.extend({id:e.attr("id"),width:e.attr("width"),height:e.attr("height"),style:w},c.video.attrs)),c.video.attrs&&(b=c.video.attrs.poster),p=c.video.sources=o(c.video.sources),p[0].type||(E.attr("src",p[0].src),p.splice(0,1));for(m=0;m<p.length;m++)h=(new r("source",1)).attr(p[m]),h.shortEnded=!0,E.append(h);c.params.src=""}if(v.name==="EmbeddedAudio"){a=new r("embed",1),a.shortEnded=!0,a.attr({id:e.attr("id"),width:e.attr("width"),height:e.attr("height"),style:w,type:e.attr("type")});for(f in c.params)a.attr(f,c.params[f]);tinymce.each(t,function(e){c[e]&&e!="type"&&a.attr(e,c[e])}),c.params.src=""}if(c.params.src){/\.flv$/i.test(c.params.src)&&N(c.params.src,""),n&&n.force_absolute&&(c.params.src=T.documentBaseURI.toAbsolute(c.params.src)),u=(new r("object",1)).attr({id:e.attr("id"),width:e.attr("width"),height:e.attr("height"),style:w}),tinymce.each(t,function(e){var t=c[e];e=="class"&&t&&(t=t.replace(/mceItem.+ ?/g,"")),t&&e!="type"&&u.attr(e,t)});for(f in c.params)d=new r("param",1),d.shortEnded=!0,l=c.params[f],f==="src"&&v.name==="WindowsMedia"&&(f="url"),d.attr({name:f,value:l}),u.append(d);if(this.editor.getParam("media_strict",!0))u.attr({data:c.params.src,type:v.mimes[0]});else{u.attr({classid:"clsid:"+v.clsids[0],codebase:v.codebase}),a=new r("embed",1),a.shortEnded=!0,a.attr({id:e.attr("id"),width:e.attr("width"),height:e.attr("height"),style:w,type:v.mimes[0]});for(f in c.params)a.attr(f,c.params[f]);tinymce.each(t,function(e){c[e]&&e!="type"&&a.attr(e,c[e])}),u.append(a)}c.object_html&&(l=new r("#text",3),l.raw=!0,l.value=c.object_html,u.append(l)),s&&s.append(u)}s&&c.video_html&&(l=new r("#text",3),l.raw=!0,l.value=c.video_html,s.append(l)),E&&c.video_html&&(l=new r("#text",3),l.raw=!0,l.value=c.video_html,E.append(l)),S=s||E||u||a,S?e.replace(S):e.remove()},objectToImg:function(s){function D(e){return(new tinymce.html.Serializer({inner:!0,validate:!1})).serialize(e)}function P(e,t){return O[(e.attr(t)||"").toLowerCase()]}function H(e){var t=e.replace(/^.*\.([^.]+)$/,"$1");return O[t.toLowerCase()||""]}var o,u,a,f,l,c,h,p,d,v,m,g,y,b,w,E,S,x,T,N,C,k,L,A,O=this.lookup,M=this.editor.settings.url_converter,_=this.editor.settings.url_converter_scope;if(!s.parent)return;if(s.name==="script"){s.firstChild&&(T=e.exec(s.firstChild.value));if(!T)return;x=T[1],S={video:{},params:i.parse(T[2])},p=S.params.width,d=S.params.height}S=S||{video:{},params:{}},l=new r("img",1),l.attr({src:this.editor.theme.url+"/img/trans.gif"}),c=s.name;if(c==="video"||c=="audio"){a=s,o=s.getAll("object")[0],u=s.getAll("embed")[0],p=a.attr("width"),d=a.attr("height"),h=a.attr("id"),S.video={attrs:{},sources:[]},N=S.video.attrs;for(c in a.attributes.map)N[c]=a.attributes.map[c];w=s.attr("src"),w&&S.video.sources.push({src:M.call(_,w,"src",s.name)}),E=a.getAll("source");for(m=0;m<E.length;m++)w=E[m].remove(),S.video.sources.push({src:M.call(_,w.attr("src"),"src","source"),type:w.attr("type"),media:w.attr("media")});N.poster&&(N.poster=M.call(_,N.poster,"poster",s.name))}s.name==="object"&&(o=s,u=s.getAll("embed")[0]),s.name==="embed"&&(u=s),s.name==="iframe"&&(f=s,x="Iframe");if(o){p=p||o.attr("width"),d=d||o.attr("height"),v=v||o.attr("style"),h=h||o.attr("id"),C=C||o.attr("hspace"),k=k||o.attr("vspace"),L=L||o.attr("align"),A=A||o.attr("bgcolor"),S.name=o.attr("name"),b=o.getAll("param");for(m=0;m<b.length;m++)y=b[m],c=y.remove().attr("name"),n[c]||(S.params[c]=y.attr("value"));S.params.src=S.params.src||o.attr("data")}if(u){p=p||u.attr("width"),d=d||u.attr("height"),v=v||u.attr("style"),h=h||u.attr("id"),C=C||u.attr("hspace"),k=k||u.attr("vspace"),L=L||u.attr("align"),A=A||u.attr("bgcolor");for(c in u.attributes.map)!n[c]&&!S.params[c]&&(S.params[c]=u.attributes.map[c])}if(f){p=f.attr("width"),d=f.attr("height"),v=v||f.attr("style"),h=f.attr("id"),C=f.attr("hspace"),k=f.attr("vspace"),L=f.attr("align"),A=f.attr("bgcolor"),tinymce.each(t,function(e){l.attr(e,f.attr(e))});for(c in f.attributes.map)!n[c]&&!S.params[c]&&(S.params[c]=f.attributes.map[c])}S.params.movie&&(S.params.src=S.params.src||S.params.movie,delete S.params.movie),S.params.src&&(S.params.src=M.call(_,S.params.src,"src","object")),a&&(s.name==="video"?x=O.video.name:s.name==="audio"&&(x=O.audio.name)),o&&!x&&(x=(P(o,"clsid")||P(o,"classid")||P(o,"type")||{}).name),u&&!x&&(x=(P(u,"type")||H(S.params.src)||{}).name),u&&x=="EmbeddedAudio"&&(S.params.type=u.attr("type")),s.replace(l),u&&u.remove(),o&&(g=D(o.remove()),g&&(S.object_html=g)),a&&(g=D(a.remove()),g&&(S.video_html=g)),S.hspace=C,S.vspace=k,S.align=L,S.bgcolor=A,l.attr({id:h,"class":"mceItemMedia mceItem"+(x||"Flash"),style:v,width:p||(s.name=="audio"?"300":"320"),height:d||(s.name=="audio"?"32":"240"),hspace:C,vspace:k,align:L,bgcolor:A,"data-mce-json":i.serialize(S,"'")})}}),tinymce.PluginManager.add("media",tinymce.plugins.MediaPlugin)})();