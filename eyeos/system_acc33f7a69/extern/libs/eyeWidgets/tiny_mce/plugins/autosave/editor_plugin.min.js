(function(e){var t,n,r="autosave",i="restoredraft",s=!0,o=e.util.Dispatcher;e.create("tinymce.plugins.AutoSave",{init:function(u){function l(e){var t={s:1e3,m:6e4};return e=/^(\d+)([ms]?)$/.exec(""+e),(e[2]?t[e[2]]:1)*parseInt(e)}var a=this,f=u.settings;a.editor=u,e.each({ask_before_unload:s,interval:"30s",retention:"20m",minlength:50},function(e,n){n=r+"_"+n,f[n]===t&&(f[n]=e)}),f.autosave_interval=l(f.autosave_interval),f.autosave_retention=l(f.autosave_retention),u.addButton(i,{title:r+".restore_content",onclick:function(){u.getContent({draft:!0}).replace(/\s|&nbsp;|<\/?p[^>]*>|<br[^>]*>/gi,"").length>0?u.windowManager.confirm(r+".warning_message",function(e){e&&a.restoreDraft()}):a.restoreDraft()}}),u.onNodeChange.add(function(){var e=u.controlManager;e.get(i)&&e.setDisabled(i,!a.hasDraft())}),u.onInit.add(function(){u.controlManager.get(i)&&(a.setupStorage(u),setInterval(function(){a.storeDraft(),u.nodeChanged()},f.autosave_interval))}),a.onStoreDraft=new o(a),a.onRestoreDraft=new o(a),a.onRemoveDraft=new o(a),n||(window.onbeforeunload=e.plugins.AutoSave._beforeUnloadHandler,n=s)},getInfo:function(){return{longname:"Auto save",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/autosave",version:e.majorVersion+"."+e.minorVersion}},getExpDate:function(){return(new Date((new Date).getTime()+this.editor.settings.autosave_retention)).toUTCString()},setupStorage:function(t){var n=this,i=r+"_test",o="OK";n.key=r+t.id,e.each([function(){if(localStorage){localStorage.setItem(i,o);if(localStorage.getItem(i)===o)return localStorage.removeItem(i),localStorage}},function(){if(sessionStorage){sessionStorage.setItem(i,o);if(sessionStorage.getItem(i)===o)return sessionStorage.removeItem(i),sessionStorage}},function(){if(e.isIE)return t.getElement().style.behavior="url('#default#userData')",{autoExpires:s,setItem:function(e,r){var i=t.getElement();i.setAttribute(e,r),i.expires=n.getExpDate();try{i.save("TinyMCE")}catch(s){}},getItem:function(e){var n=t.getElement();try{return n.load("TinyMCE"),n.getAttribute(e)}catch(r){return null}},removeItem:function(e){t.getElement().removeAttribute(e)}}}],function(e){try{n.storage=e();if(n.storage)return!1}catch(t){}})},storeDraft:function(){var e,t,n=this,r=n.storage,i=n.editor;if(r){if(!r.getItem(n.key)&&!i.isDirty())return;t=i.getContent({draft:!0}),t.length>i.settings.autosave_minlength&&(e=n.getExpDate(),n.storage.autoExpires||n.storage.setItem(n.key+"_expires",e),n.storage.setItem(n.key,t),n.onStoreDraft.dispatch(n,{expires:e,content:t}))}},restoreDraft:function(){var e,t=this,n=t.storage;n&&(e=n.getItem(t.key),e&&(t.editor.setContent(e),t.onRestoreDraft.dispatch(t,{content:e})))},hasDraft:function(){var e,t,n=this,r=n.storage;if(r){t=!!r.getItem(n.key);if(t){if(!!n.storage.autoExpires)return s;e=new Date(r.getItem(n.key+"_expires"));if((new Date).getTime()<e.getTime())return s;n.removeDraft()}}return!1},removeDraft:function(){var e,t=this,n=t.storage,r=t.key;n&&(e=n.getItem(r),n.removeItem(r),n.removeItem(r+"_expires"),e&&t.onRemoveDraft.dispatch(t,{content:e}))},"static":{_beforeUnloadHandler:function(){var t;return e.each(tinyMCE.editors,function(e){e.plugins.autosave&&e.plugins.autosave.storeDraft();if(e.getParam("fullscreen_is_enabled"))return;!t&&e.isDirty()&&e.getParam("autosave_ask_before_unload")&&(t=e.getLang("autosave.unload_msg"))}),t}}}),e.PluginManager.add("autosave",e.plugins.AutoSave)})(tinymce);