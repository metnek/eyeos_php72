(function(){var e=tinymce.each,t=tinymce.html.Node;tinymce.create("tinymce.plugins.FullPagePlugin",{init:function(e,t){var n=this;n.editor=e,e.addCommand("mceFullPageProperties",function(){e.windowManager.open({file:t+"/fullpage.htm",width:430+parseInt(e.getLang("fullpage.delta_width",0)),height:495+parseInt(e.getLang("fullpage.delta_height",0)),inline:1},{plugin_url:t,data:n._htmlToData()})}),e.addButton("fullpage",{title:"fullpage.desc",cmd:"mceFullPageProperties"}),e.onBeforeSetContent.add(n._setContent,n),e.onGetContent.add(n._getContent,n)},getInfo:function(){return{longname:"Fullpage",author:"Moxiecode Systems AB",authorurl:"http://tinymce.moxiecode.com",infourl:"http://wiki.moxiecode.com/index.php/TinyMCE:Plugins/fullpage",version:tinymce.majorVersion+"."+tinymce.minorVersion}},_htmlToData:function(){function o(e,t){var n=e.attr(t);return n||""}var t,n,r=this._parseHeader(),i={},s=this.editor;return i.fontface=s.getParam("fullpage_default_fontface",""),i.fontsize=s.getParam("fullpage_default_fontsize",""),t=r.firstChild,t.type==7&&(i.xml_pi=!0,n=/encoding="([^"]+)"/.exec(t.value),n&&(i.docencoding=n[1])),t=r.getAll("#doctype")[0],t&&(i.doctype="<!DOCTYPE"+t.value+">"),t=r.getAll("title")[0],t&&t.firstChild&&(i.metatitle=t.firstChild.value),e(r.getAll("meta"),function(e){var t,n=e.attr("name"),r=e.attr("http-equiv");n?i["meta"+n.toLowerCase()]=e.attr("content"):r=="Content-Type"&&(t=/charset\s*=\s*(.*)\s*/gi.exec(e.attr("content")),t&&(i.docencoding=t[1]))}),t=r.getAll("html")[0],t&&(i.langcode=o(t,"lang")||o(t,"xml:lang")),t=r.getAll("link")[0],t&&t.attr("rel")=="stylesheet"&&(i.stylesheet=t.attr("href")),t=r.getAll("body")[0],t&&(i.langdir=o(t,"dir"),i.style=o(t,"style"),i.visited_color=o(t,"vlink"),i.link_color=o(t,"link"),i.active_color=o(t,"alink")),i},_dataToHtml:function(n){function f(e,t,n){e.attr(t,n?n:undefined)}function l(e){i.firstChild?i.insert(e,i.firstChild):i.append(e)}var r,i,s,o,u,a=this.editor.dom;r=this._parseHeader(),i=r.getAll("head")[0],i||(o=r.getAll("html")[0],i=new t("head",1),o.firstChild?o.insert(i,o.firstChild,!0):o.append(i)),o=r.firstChild,n.xml_pi?(u='version="1.0"',n.docencoding&&(u+=' encoding="'+n.docencoding+'"'),o.type!=7&&(o=new t("xml",7),r.insert(o,r.firstChild,!0)),o.value=u):o&&o.type==7&&o.remove(),o=r.getAll("#doctype")[0],n.doctype?(o||(o=new t("#doctype",10),n.xml_pi?r.insert(o,r.firstChild):l(o)),o.value=n.doctype.substring(9,n.doctype.length-1)):o&&o.remove(),o=r.getAll("title")[0],n.metatitle&&(o||(o=new t("title",1),o.append(new t("#text",3)).value=n.metatitle,l(o))),n.docencoding&&(o=null,e(r.getAll("meta"),function(e){e.attr("http-equiv")=="Content-Type"&&(o=e)}),o||(o=new t("meta",1),o.attr("http-equiv","Content-Type"),o.shortEnded=!0,l(o)),o.attr("content","text/html; charset="+n.docencoding)),e("keywords,description,author,copyright,robots".split(","),function(e){var i,s,u=r.getAll("meta"),a=n["meta"+e];for(i=0;i<u.length;i++){s=u[i];if(s.attr("name")==e){a?s.attr("content",a):s.remove();return}}a&&(o=new t("meta",1),o.attr("name",e),o.attr("content",a),o.shortEnded=!0,l(o))}),o=r.getAll("link")[0],o&&o.attr("rel")=="stylesheet"?n.stylesheet?o.attr("href",n.stylesheet):o.remove():n.stylesheet&&(o=new t("link",1),o.attr({rel:"stylesheet",text:"text/css",href:n.stylesheet}),o.shortEnded=!0,l(o)),o=r.getAll("body")[0],o&&(f(o,"dir",n.langdir),f(o,"style",n.style),f(o,"vlink",n.visited_color),f(o,"link",n.link_color),f(o,"alink",n.active_color),a.setAttribs(this.editor.getBody(),{style:n.style,dir:n.dir,vLink:n.visited_color,link:n.link_color,aLink:n.active_color})),o=r.getAll("html")[0],o&&(f(o,"lang",n.langcode),f(o,"xml:lang",n.langcode)),s=(new tinymce.html.Serializer({validate:!1,indent:!0,apply_source_formatting:!0,indent_before:"head,html,body,meta,title,script,link,style",indent_after:"head,html,body,meta,title,script,link,style"})).serialize(r),this.head=s.substring(0,s.indexOf("</body>"))},_parseHeader:function(){return(new tinymce.html.DomParser({validate:!1,root_name:"#document"})).parse(this.head)},_setContent:function(t,n){function c(e){return e.replace(/<\/?[A-Z]+/g,function(e){return e.toLowerCase()})}var r,i,s,o,u=this,a=n.content,f="",l=u.editor.dom;if(n.format=="raw"&&u.head)return;if(n.source_view&&t.getParam("fullpage_hide_in_source_view"))return;a=a.replace(/<(\/?)BODY/gi,"<$1body"),r=a.indexOf("<body"),r!=-1?(r=a.indexOf(">",r),u.head=c(a.substring(0,r+1)),i=a.indexOf("</body",r),i==-1&&(i=a.length),n.content=a.substring(r+1,i),u.foot=c(a.substring(i))):(u.head=this._getDefaultHeader(),u.foot="\n</body>\n</html>"),s=u._parseHeader(),e(s.getAll("style"),function(e){e.firstChild&&(f+=e.firstChild.value)}),o=s.getAll("body")[0],o&&l.setAttribs(u.editor.getBody(),{style:o.attr("style")||"",dir:o.attr("dir")||"",vLink:o.attr("vlink")||"",link:o.attr("link")||"",aLink:o.attr("alink")||""}),l.remove("fullpage_styles"),f&&(l.add(u.editor.getDoc().getElementsByTagName("head")[0],"style",{id:"fullpage_styles"},f),o=l.get("fullpage_styles"),o.styleSheet&&(o.styleSheet.cssText=f))},_getDefaultHeader:function(){var e,t="",n=this.editor,r="";n.getParam("fullpage_default_xml_pi")&&(t+='<?xml version="1.0" encoding="'+n.getParam("fullpage_default_encoding","ISO-8859-1")+'" ?>\n'),t+=n.getParam("fullpage_default_doctype",'<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">'),t+="\n<html>\n<head>\n";if(e=n.getParam("fullpage_default_title"))t+="<title>"+e+"</title>\n";if(e=n.getParam("fullpage_default_encoding"))t+='<meta http-equiv="Content-Type" content="text/html; charset='+e+'" />\n';if(e=n.getParam("fullpage_default_font_family"))r+="font-family: "+e+";";if(e=n.getParam("fullpage_default_font_size"))r+="font-size: "+e+";";if(e=n.getParam("fullpage_default_text_color"))r+="color: "+e+";";return t+="</head>\n<body"+(r?' style="'+r+'"':"")+">\n",t},_getContent:function(e,t){var n=this;if(!t.source_view||!e.getParam("fullpage_hide_in_source_view"))t.content=tinymce.trim(n.head)+"\n"+tinymce.trim(t.content)+"\n"+tinymce.trim(n.foot)}}),tinymce.PluginManager.add("fullpage",tinymce.plugins.FullPagePlugin)})();